!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("infestines"),require("kefir"),require("partial.lenses")):"function"==typeof define&&define.amd?define(["exports","infestines","kefir","partial.lenses"],t):t((e.kefir=e.kefir||{},e.kefir.atom=e.kefir.atom||{}),e.I,e.kefir,e.L)}(this,function(e,t,n,i){"use strict";function r(e){throw new Error(_+e)}function o(){for(;y.length;){var e=y.shift(),n=m.shift(),i=n._currentEvent.value;t.identicalU(e,i)||n._emitValue(i)}}function u(e){++d;try{return e()}finally{--d||o()}}function s(e,n){var i=e._currentEvent;i&&t.identicalU(i.value,n)||e._emitValue(n)}function c(e,t,n,i){d?(m.indexOf(e)<0&&(y.push(t?n:r),m.push(e)),t?t.value=i:e._currentEvent={type:"value",value:i}):s(e,i)}function a(e){var t=e._$onSource;t&&e._source.offAny(t),e._source=e._$onSource=void 0}function f(e,n){if(e instanceof g&&n.indexOf(e)<0)n.push(e);else if(t.isArray(e))for(var i=0,r=e.length;i<r;++i)f(e[i],n);else if(t.isObject(e))for(var o in e)f(e[o],n)}function l(e){if(e instanceof g)return e.get();if(t.isArray(e)){for(var n=e.length,i=e,r=0;r<n;++r){var o=l(e[r]);t.identicalU(i[r],o)||(i===e&&(i=e.slice(0)),i[r]=o)}return i}if(t.isObject(e)){var u=e;for(var s in e){var c=l(e[s]);t.identicalU(u[s],c)||(u===e&&(u=t.assocPartialU(void 0,void 0,e)),u[s]=c)}return u}return e}function h(e,n){if(e instanceof g)return e.set(n);if(t.isArray(e)&&t.isArray(n))for(var i=0,o=e.length;i<o;++i)h(e[i],n[i]);else if(t.isObject(e)&&t.isObject(n))for(var u in e)h(e[u],n[u]);else t.identicalU(e,n)||r("Molecule cannot change the template.")}function v(){return arguments.length?new S(arguments[0]):new S}var _="kefir.atom: ",d=0,y=[],m=[],g=t.inherit(function(){n.Property.call(this)},n.Property,{set:function(e){this.modify(t.always(e))},remove:function(){this.set()},view:function(e){return new A(this,e)}}),p=t.inherit(function(e){g.call(this),this._source=e,this._$onAny=void 0},g,{get:function(){var e=this._currentEvent;return e&&!d?e.value:this._getFromSource()},_onActivation:function(){var e=this;this._source.onAny(this._$onAny=function(t){switch(t.type){case"value":return s(e,e._getFromSource());case"error":return e._emitError(t.value);default:return e._$onAny=void 0,e._emitEnd()}})},_onDeactivation:function(){var e=this._$onAny;e&&this._source.offAny(e),this._$onAny=void 0}}),A=t.inherit(function(e,t){p.call(this,e),this._lens=t},p,{set:function(e){this._source.set(i.set(this._lens,e,this._source.get()))},modify:function(e){this._source.modify(i.modify(this._lens,e))},_getFromSource:function(){return i.get(this._lens,this._source.get())}}),S=t.inherit(function(){g.call(this),arguments.length&&this._emitValue(arguments[0])},g,{get:function(){var e=this._currentEvent;return e?e.value:void 0},set:function(e){var t=this._currentEvent;c(this,t,t?t.value:void 0,e)},modify:function(e){var t=this._currentEvent,n=t?t.value:void 0;c(this,t,n,e(n))}}),$=t.inherit(function(e){g.call(this),this._sources=e,this._source=this._$onSources=this._$onSource=void 0},g,{get:function(){var e=this._source;return e&&e.get()},modify:function(e){var t=this._source;t&&t.modify(e)},_onActivation:function(){var e=this,t=this._sources;t&&t.onAny(this._$onSources=function(t){switch(t.type){case"value":return a(e),(e._source=t.value).onAny(e._$onSource=function(t){switch(t.type){case"value":return s(e,e._source.get());case"error":return e._emitError(t.value);default:return e._emitEnd()}});case"error":return e._emitError(t.value);default:e._$onSources=void 0}})},_onDeactivation:function(){a(this);var e=this._$onSources;e&&this._sources.offAny(e),this._$onSources=void 0}}),E=n.constant(t.array0),b=t.inherit(function(e){var t=[];f(e,t),p.call(this,t.length?n.combine(t):E),this._template=e},p,{_getFromSource:function(){return l(this._template)},modify:function(e){var t=this,n=e(this.get());u(function(){return h(t._template,n)})}});e.holding=u,e.AbstractMutable=g,e.MutableWithSource=p,e.LensedAtom=A,e.Atom=S,e.Join=$,e.Molecule=b,e.default=v,Object.defineProperty(e,"__esModule",{value:!0})});
